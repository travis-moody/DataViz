<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chicago Crime & Weather Analysis Dashboard</title>
  <!-- Include Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Include React and ReactDOM from CDN -->
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Include Recharts for visualizations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.5.0/recharts.min.js"></script>
  <!-- Include PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Include Lodash for data manipulation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <!-- Include Babel for JSX transformation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.4/babel.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9fafb;
    }
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 100px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="root" class="min-h-screen">
    <div class="loader"></div>
  </div>

  <!-- Point this to the raw GitHub URL for your CSV file -->
  <script>
    const CSV_URL = 'https://raw.githubusercontent.com/travis-moody/DataViz/(root)/Crime_Weather_Merged.csv';
  </script>

  <!-- Main React Application -->
  <script type="text/babel">
    const {
      LineChart, Line, BarChart, Bar, ComposedChart, Area, ScatterChart, Scatter,
      XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell
    } = Recharts;

    const Dashboard = () => {
      const [data, setData] = React.useState([]);
      const [monthlyData, setMonthlyData] = React.useState([]);
      const [seasonalData, setSeasonalData] = React.useState([]);
      const [temperatureData, setTemperatureData] = React.useState([]);
      const [precipData, setPrecipData] = React.useState([]);
      const [snowData, setSnowData] = React.useState([]);
      const [correlationData, setCorrelationData] = React.useState([]);
      const [dayOfWeekData, setDayOfWeekData] = React.useState([]);
      const [yearlyData, setYearlyData] = React.useState([]);
      const [highCrimeDays, setHighCrimeDays] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [activeTab, setActiveTab] = React.useState('monthly');

      React.useEffect(() => {
        Papa.parse(CSV_URL, {
          download: true,
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (parsed) => {
            const rawData = parsed.data.map(row => {
              const newRow = { ...row };
              if (newRow.date) {
                const [m, d, y] = newRow.date.split('/');
                newRow.dateObj = new Date(+y, m - 1, +d);
                newRow.year = +y;
                newRow.month = +m;
                newRow.day = +d;
                newRow.dayOfWeek = newRow.dateObj.getDay();
                const seasons = {
                  12:'Winter',1:'Winter',2:'Winter',
                  3:'Spring',4:'Spring',5:'Spring',
                  6:'Summer',7:'Summer',8:'Summer',
                  9:'Fall',10:'Fall',11:'Fall'
                };
                newRow.season = seasons[newRow.month];
                const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                newRow.monthName = monthNames[newRow.month - 1];
              }
              return newRow;
            });
            setData(rawData);

            // Monthly trends
            setMonthlyData(
              _.chain(rawData)
                .groupBy('month')
                .map((items, m) => ({
                  month: +m,
                  monthName: items[0].monthName,
                  avgCrime: _.meanBy(items, 'crime_count'),
                  avgTemp: _.meanBy(items, 'TAVG')
                }))
                .sortBy('month')
                .value()
            );

            // Day of week
            setDayOfWeekData(
              _.chain(rawData)
                .groupBy('dayOfWeek')
                .map((items, dow) => ({
                  dayOfWeek: +dow,
                  dayName: ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][+dow],
                  avgCrime: _.meanBy(items, 'crime_count')
                }))
                .sortBy('dayOfWeek')
                .value()
            );

            // Seasonal patterns
            setSeasonalData(
              _.chain(rawData)
                .groupBy('season')
                .map((items, season) => ({
                  season,
                  avgCrime: _.meanBy(items, 'crime_count'),
                  avgTemp: _.meanBy(items, 'TAVG')
                }))
                .value()
            );

            // Temperature ranges
            const tempRanges = [
              { min:-30, max:0, label:'Below Freezing' },
              { min:1, max:32, label:'Cold' },
              { min:33, max:50, label:'Cool' },
              { min:51, max:70, label:'Mild' },
              { min:71, max:85, label:'Warm' },
              { min:86, max:120, label:'Hot' }
            ];
            setTemperatureData(
              tempRanges.map(r => {
                const items = rawData.filter(x => x.TAVG >= r.min && x.TAVG <= r.max);
                return { tempRange: r.label, avgCrime: _.meanBy(items, 'crime_count') };
              })
            );

            // Precipitation ranges
            const precipRanges = [
              { min:0, max:0, label:'No precipitation' },
              { min:0.01, max:0.1, label:'Light precipitation' },
              { min:0.11, max:0.5, label:'Moderate precipitation' },
              { min:0.51, max:2, label:'Heavy precipitation' }
            ];
            setPrecipData(
              precipRanges.map(r => {
                const items = rawData.filter(x => x.PRCP >= r.min && x.PRCP <= r.max);
                return { precipRange: r.label, avgCrime: _.meanBy(items, 'crime_count') };
              })
            );

            // Snow ranges
            const snowRanges = [
              { min:0, max:0, label:'No snow' },
              { min:0.01, max:1, label:'Light snow' },
              { min:1.01, max:3, label:'Moderate snow' },
              { min:3.01, max:20, label:'Heavy snow' }
            ];
            setSnowData(
              snowRanges.map(r => {
                const items = rawData.filter(x => x.SNOW >= r.min && x.SNOW <= r.max);
                return { snowRange: r.label, avgCrime: _.meanBy(items, 'crime_count') };
              })
            );

            // Correlations
            const calcCorr = (xKey) => {
              const vals = rawData.filter(r => r[xKey] != null && r.crime_count != null);
              const xs = vals.map(r => r[xKey]);
              const ys = vals.map(r => r.crime_count);
              const n = xs.length;
              const xMean = _.mean(xs);
              const yMean = _.mean(ys);
              let num=0, denX=0, denY=0;
              for (let i=0;i<n;i++){
                const dx=xs[i]-xMean, dy=ys[i]-yMean;
                num += dx*dy; denX += dx*dx; denY += dy*dy;
              }
              return num/Math.sqrt(denX*denY);
            };
            const weatherVars = [
              { id:'TAVG', name:'Avg Temp' },
              { id:'PRCP', name:'Precipitation' },
              { id:'SNOW', name:'Snowfall' }
            ];
            setCorrelationData(
              weatherVars.map(v => ({
                variable: v.name,
                correlation: calcCorr(v.id)
              }))
            );

            // Yearly trends
            setYearlyData(
              _.chain(rawData)
                .groupBy('year')
                .map((items, y) => ({
                  year: +y,
                  avgCrime: _.meanBy(items, 'crime_count')
                }))
                .sortBy('year')
                .value()
            );

            // Top 10 crime days
            setHighCrimeDays(
              _.chain(rawData)
                .orderBy(['crime_count'], ['desc'])
                .take(10)
                .map(r => ({ date: r.date, crimeCount: r.crime_count }))
                .value()
            );

            setLoading(false);
          }
        });
      }, []);

      const CustomTooltip = ({ active, payload, label }) => {
        if (active && payload) {
          return (
            <div className="bg-white p-3 border border-gray-200 rounded shadow">
              <p className="font-semibold">{label}</p>
              {payload.map((e,i) => (
                <p key={i}>{e.name}: {e.value}</p>
              ))}
            </div>
          );
        }
        return null;
      };

      if (loading) {
        return <div className="text-center py-12">Loading data...</div>;
      }

      const renderMonthly = () => (
        <ResponsiveContainer width="100%" height={300}>
          <ComposedChart data={monthlyData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="monthName" />
            <YAxis yAxisId="left" label={{ value: 'Avg Crime', angle: -90, position: 'insideLeft' }} />
            <YAxis yAxisId="right" orientation="right" label={{ value: 'Avg Temp', angle: 90, position: 'insideRight' }} />
            <Tooltip content={<CustomTooltip />} />
            <Legend />
            <Bar yAxisId="left" dataKey="avgCrime" name="Avg Crime" />
            <Line yAxisId="right" dataKey="avgTemp" name="Avg Temp" dot />
          </ComposedChart>
        </ResponsiveContainer>
      );

      const renderDayOfWeek = () => (
        <ResponsiveContainer width="100%" height={300}>
          <BarChart data={dayOfWeekData}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="dayName" />
            <YAxis label={{ value: 'Avg Crime', angle: -90, position: 'insideLeft' }} />
            <Tooltip content={<CustomTooltip />} />
            <Bar dataKey="avgCrime" name="Avg Crime" fill="#82ca9d" />
          </BarChart>
        </ResponsiveContainer>
      );

      // ... similarly, renderSeasonal, renderTemperature, renderPrecip, renderSnow,
      // renderCorrelation, renderYearly, renderHighCrimeDays

      const renderContent = () => {
        switch(activeTab) {
          case 'monthly': return renderMonthly();
          case 'dayOfWeek': return renderDayOfWeek();
          // add other cases here...
          default: return renderMonthly();
        }
      };

      return (
        <div className="p-4 max-w-7xl mx-auto">
          <h1 className="text-2xl font-bold mb-4">Chicago Crime & Weather Analysis</h1>
          <div className="flex space-x-2 mb-6">
            {[
              { id:'monthly', label:'Monthly' },
              { id:'dayOfWeek', label:'Day of Week' },
              { id:'seasonal', label:'Seasonal' },
              { id:'temperature', label:'Temperature' },
              { id:'precipitation', label:'Precipitation' },
              { id:'correlation', label:'Correlations' },
              { id:'yearly', label:'Yearly Trends' },
              { id:'highCrime', label:'Top Crime Days' }
            ].map(tab => (
              <button
                key={tab.id}
                className={`px-3 py-1 rounded ${activeTab===tab.id ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}
                onClick={() => setActiveTab(tab.id)}
              >{tab.label}</button>
            ))}
          </div>

          {renderContent()}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<Dashboard />);
  </script>
</body>
</html>

